<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Despacho - Al Sahara</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../core/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils"></i> Al Sahara
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navMenu"></ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Dispatch Content -->
    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-truck"></i> Cola de Pedidos - Despacho</h2>
            <button class="btn btn-primary" onclick="renderDispatch()">
                <i class="fas fa-sync"></i> Actualizar
            </button>
        </div>
        
        <div id="dispatchQueue"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://127.0.0.1:8000/api';
        let usuarioLogueado = null;

        // --- Elementos del DOM ---
        const dispatchQueue = document.getElementById('dispatchQueue');

        // --- Funciones de Ayuda (Logout, Navbar) ---
        const handleLogout = async () => {
            try {
                await fetch(`${API_URL}/auth/logout/`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) { console.error('Error en logout:', error); }
            window.location.href = 'index.html';
        };

        const setupNavbar = (user) => {
            const navMenu = document.getElementById('navMenu');
            if (!navMenu) return;
            const welcomeName = user.first_name || user.email;
            let menuHtml = `
                <li class="nav-item"><a class="nav-link" href="catalog-staff.html">Menú Staff</a></li>
                <li class="nav-item"><a class="nav-link" href="cashier.html">Caja</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="dispatch.html">Despachos</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-register.html">Registrar</a></li>
            `;
            if (user.role === 'admin') {
                menuHtml += `<li class="nav-item"><a class="nav-link" href="reports.html">Reportes</a></li>`;
            }
            menuHtml += `
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        Hola, ${welcomeName} (${user.role})
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="profile.html">Mi Perfil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutButton">Cerrar Sesión</a></li>
                    </ul>
                </li>
            `;
            navMenu.innerHTML = menuHtml;
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        };

        // --- Lógica de Despacho ---

        // 3. Renderiza los pedidos en el HTML
        // (Esta es la función que llama el botón 'onclick' del HTML)
        const renderDispatch = async () => {
            dispatchQueue.innerHTML = '<p>Actualizando...</p>';
            let pedidos = [];

            try {
                // 1. Llama a la API que creamos en views.py
                const response = await fetch(`${API_URL}/pedidos/dispatch_list/`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('No se pudo cargar la cola');
                
                pedidos = await response.json();
                dispatchQueue.innerHTML = ''; // Limpiar

            } catch (error) {
                console.error(error);
                dispatchQueue.innerHTML = '<div class="alert alert-danger">Error al cargar la cola de despacho.</div>';
                return;
            }

            if (pedidos.length === 0) {
                dispatchQueue.innerHTML = '<div class="alert alert-info">No hay pedidos "En Preparación" o "En Camino".</div>';
                return;
            }

            // Separar pedidos en dos listas
            const enPreparacion = pedidos.filter(p => p.estado === 'EN PREPARACION');
            const enCamino = pedidos.filter(p => p.estado === 'EN CAMINO');

            // Renderizar pedidos "EN PREPARACIÓN"
            dispatchQueue.innerHTML += '<h4 class="mb-3">En Preparación (Listos para retirar)</h4>';
            if (enPreparacion.length > 0) {
                enPreparacion.forEach(pedido => {
                    dispatchQueue.innerHTML += renderPedidoCard(pedido, 'EN CAMINO');
                });
            } else {
                dispatchQueue.innerHTML += '<p class="text-muted">No hay pedidos en preparación.</p>';
            }

            // Renderizar pedidos "EN CAMINO"
            dispatchQueue.innerHTML += '<hr class="my-4"><h4 class="mb-3">En Camino (En ruta)</h4>';
            if (enCamino.length > 0) {
                enCamino.forEach(pedido => {
                    dispatchQueue.innerHTML += renderPedidoCard(pedido, 'ENTREGADO');
                });
            } else {
                dispatchQueue.innerHTML += '<p class="text-muted">No hay pedidos en ruta.</p>';
            }
        };

        // 4. Función de ayuda para dibujar cada tarjeta de pedido
        const renderPedidoCard = (pedido, nextStatus) => {
            let itemsHtml = '';
            pedido.items.forEach(item => {
                itemsHtml += `<li><strong>${item.cantidad}x</strong> ${item.nombre_producto}</li>`;
            });

            let buttonText = '';
            let buttonClass = '';
            if (nextStatus === 'EN CAMINO') {
                buttonText = '<i class="fas fa-truck"></i> Marcar EN CAMINO';
                buttonClass = 'btn-primary';
            } else if (nextStatus === 'ENTREGADO') {
                buttonText = '<i class="fas fa-check-circle"></i> Marcar ENTREGADO';
                buttonClass = 'btn-success';
            }

            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-5">
                                <strong>Pedido #${pedido.id}</strong>
                                <p class="small text-muted mb-2">${pedido.usuario.first_name || pedido.usuario.email} | ${pedido.direccion_entrega}</p>
                                <ul class="list-unstyled mb-0">${itemsHtml}</ul>
                            </div>
                            <div class="col-md-4">
                                <strong>Total: $${parseFloat(pedido.total).toFixed(0)}</strong>
                                <p class="small text-muted mb-0">Método: ${pedido.metodo_pago}</p>
                            </div>
                            <div class="col-md-3 d-flex align-items-center justify-content-end">
                                <button class="btn ${buttonClass} w-100" onclick="handleUpdateStatus(this, ${pedido.id}, '${nextStatus}')">
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // 2. LLAMA a la API para cambiar el estado
        const handleUpdateStatus = async (buttonElement, pedidoId, newStatus) => {
            // 1. Ya no usamos confirm(), el clic es la confirmación
            // if (!confirm(...)) return;

            // 2. Guardar estado original y deshabilitar botón
            const originalHtml = buttonElement.innerHTML;
            const originalClasses = buttonElement.className;
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // 3. Llamar a la API
                const response = await fetch(`${API_URL}/pedidos/${pedidoId}/update_status/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ estado: newStatus })
                });
                
                if (!response.ok) {
                    // Si la API falla, lanzamos un error
                    throw new Error('El estado no se pudo actualizar');
                }
                
                // 4. Éxito: Recargamos la lista
                // (El botón desaparecerá con la recarga, así que no hay que revertirlo)
                renderDispatch(); 

            } catch (error) {
                // 5. Error: Reemplazamos el alert()
                console.error(error);
                
                // Mostrar "Error" en el botón
                buttonElement.innerHTML = 'Error';
                buttonElement.className = 'btn btn-danger w-100'; // Cambia a color rojo

                // Revertir el botón después de 2 segundos
                setTimeout(() => {
                    buttonElement.innerHTML = originalHtml;
                    buttonElement.className = originalClasses;
                    buttonElement.disabled = false;
                }, 2000);
            }
        };

        // --- SCRIPT DE ARRANQUE (EL GUARDIÁN) ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_URL}/auth/me/`, {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    usuarioLogueado = await response.json();
                    
                    if (usuarioLogueado.role === 'staff' || usuarioLogueado.role === 'admin') {
                        // Acceso de Staff/Admin
                        setupNavbar(usuarioLogueado);
                        renderDispatch(); // 1. Cargar los pedidos al iniciar
                    } else {
                        window.location.href = 'catalog-client.html'; // Echar al cliente
                    }
                } else {
                    window.location.href = 'login.html'; // Echar si no hay sesión
                }
            } catch (error) {
                window.location.href = 'login.html'; // Echar si hay error de red
            }
        });
    </script>
</body>
</html>
