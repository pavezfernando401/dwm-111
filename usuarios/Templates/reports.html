<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - Al Sahara</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../core/styles.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-utensils"></i> Al Sahara
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="navMenu"></ul>
            </div>
        </div>
    </nav>

    <div class="toast-container"></div>

    <div class="container mt-4 mb-5">
        <h2 class="mb-4"><i class="fas fa-chart-line"></i> Reportes de Ventas</h2>
        
        <div class="card mb-4">
            <div class="card-body">
                <h5>Filtrar Período</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="reportStartDate">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="reportEndDate">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="generateReport()">
                            <i class="fas fa-chart-bar"></i> Generar Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="reportContent">
            <div class="text-center py-5 text-muted">
                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                <p>Cargando estadísticas...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';
        let usuarioLogueado = null;
        
        // Variables globales para los gráficos
        let chartMetodos = null;
        let chartProductos = null;

        // --- Navbar y Logout ---
        const handleLogout = async () => {
            try {
                await fetch(`${API_URL}/auth/logout/`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) { console.error('Error en logout:', error); }
            window.location.href = 'index.html';
        };

        const setupNavbar = (user) => {
            const navMenu = document.getElementById('navMenu');
            if (!navMenu) return;
            const welcomeName = user.first_name || user.email;
            
            let menuHtml = `
                <li class="nav-item"><a class="nav-link" href="catalog-staff.html">Menú Staff</a></li>
                <li class="nav-item"><a class="nav-link" href="cashier.html">Caja</a></li>
                <li class="nav-item"><a class="nav-link" href="dispatch.html">Despachos</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-register.html">Registrar</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="reports.html">Reportes</a></li>
            `;
            
            menuHtml += `
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        Hola, ${welcomeName} (${user.role})
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="profile.html">Mi Perfil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutButton">Cerrar Sesión</a></li>
                    </ul>
                </li>
            `;
            navMenu.innerHTML = menuHtml;
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
        };

        const generateReport = async () => {
    const container = document.getElementById('reportContent');
    
    // 1. Obtener las fechas de los inputs
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Calculando estadísticas...</p>
        </div>
    `;

    try {
        // 2. Construir la URL con los parámetros
        // Usamos URLSearchParams para facilitar la creación de la query string
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);

        // La URL final se verá como: .../reports/stats/?start_date=2025-10-01&end_date=2025-12-05
        const response = await fetch(`${API_URL}/reports/stats/?${params.toString()}`, {
            credentials: 'include'
        });
        
        if (!response.ok) throw new Error('Error cargando estadísticas');
        
        const data = await response.json();
        
        // 3. Inyectar HTML de Resumen y Gráficos (El resto sigue igual)
        container.innerHTML = `
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-white bg-primary mb-3 h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="fas fa-coins"></i> Ventas Totales</h5>
                            <p class="card-text display-6 fw-bold">$${data.resumen.total_ventas.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-success mb-3 h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="fas fa-shopping-bag"></i> Total Pedidos</h5>
                            <p class="card-text display-6 fw-bold">${data.resumen.cantidad_pedidos}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info mb-3 h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title"><i class="fas fa-receipt"></i> Ticket Promedio</h5>
                            <p class="card-text display-6 fw-bold">$${data.resumen.ticket_promedio.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white fw-bold">Métodos de Pago</div>
                        <div class="card-body">
                            <canvas id="metodosChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white fw-bold">Top 5 Productos Más Vendidos</div>
                        <div class="card-body">
                            <canvas id="productosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;

        renderCharts(data);

    } catch (error) {
        console.error(error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> No se pudieron cargar los reportes. Intenta nuevamente.
            </div>
        `;
    }
};

        const renderCharts = (data) => {
            // Destruir gráficos anteriores si existen para evitar superposición
            if (chartMetodos) chartMetodos.destroy();
            if (chartProductos) chartProductos.destroy();

            // Gráfico 1: Torta de MÉTODOS DE PAGO (Aquí está el cambio clave)
            const ctxMetodos = document.getElementById('metodosChart').getContext('2d');
            
            // Preparamos los datos
            const metodosLabels = data.graficos.metodos_pago.map(e => e.metodo_pago);
            const metodosData = data.graficos.metodos_pago.map(e => e.cantidad);

            chartMetodos = new Chart(ctxMetodos, {
                type: 'doughnut',
                data: {
                    labels: metodosLabels,
                    datasets: [{
                        data: metodosData,
                        backgroundColor: [
                            '#0d6efd', // Azul (Tarjeta)
                            '#198754', // Verde (Efectivo)
                            '#ffc107', // Amarillo (Transferencia)
                            '#6c757d'  // Gris (Otro)
                        ],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Distribución de Pagos' }
                    }
                }
            });

            // Gráfico 2: Barra de Productos
            const ctxProd = document.getElementById('productosChart').getContext('2d');
            chartProductos = new Chart(ctxProd, {
                type: 'bar',
                data: {
                    labels: data.graficos.top_productos.map(p => p.nombre_producto),
                    datasets: [{
                        label: 'Unidades Vendidas',
                        data: data.graficos.top_productos.map(p => p.total_vendido),
                        backgroundColor: '#6610f2',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        };

        // --- Guardián ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Poner fechas por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = hoy;

            try {
                const response = await fetch(`${API_URL}/auth/me/`, {
                    method: 'GET',
                    credentials: 'include'
                });
                if (response.ok) {
                    usuarioLogueado = await response.json();
                    
                    // Solo ADMIN puede ver esto
                    if (usuarioLogueado.role === 'admin') {
                        setupNavbar(usuarioLogueado);
                        // Cargar reporte automáticamente al entrar
                        generateReport();
                    } else {
                        alert("Acceso denegado: Solo administradores.");
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            } catch (error) {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>