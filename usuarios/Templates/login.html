<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión — Al Sahara</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Tu CSS (ajusta la ruta si corresponde) -->
  <link rel="stylesheet" href="./core/styles.css">
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-utensils"></i> Al Sahara</a>
    </div>
  </nav>

  <main class="container py-5" style="max-width: 680px;">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h1 class="h3 text-center mb-4">Iniciar Sesión</h1>

        <div class="alert alert-info">
          <strong>Usuarios de prueba:</strong><br>
          Cliente: correo@example.com / Elpepe2025<br>
          Admin: admin@alsahara.cl / Admin2025<br>
          Cajero: cajero@alsahara.cl / Cajero2025
        </div>

        <form id="loginForm" class="vstack gap-3">
          <div>
            <label class="form-label" for="loginEmail">Email</label>
            <input id="loginEmail" type="email" class="form-control" required />
          </div>
          <div>
            <label class="form-label" for="loginPassword">Contraseña</label>
            <input id="loginPassword" type="password" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="fa fa-right-to-bracket"></i> Iniciar sesión
          </button>
        </form>
      </div>
      </div>
        <div class="text-center mt-3">
            <div><a href="recover.html">¿Olvidaste tu contraseña?</a></div>
        <div class="mt-1"><a href="register.html">¿No tienes cuenta? Regístrate</a></div>
      </div>

  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function () {
    const API = "http://127.0.0.1:3001";

    function getRedirectTargetByRole(user) {
      if (!user) return "catalog-client.html"; // invitado no debería llegar, pero por si acaso
      if (user.role === "admin" || user.role === "cajero") return "catalog-staff.html";
      return "catalog-client.html";
    }

    function getQueryParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("loginForm");
      const email = document.getElementById("loginEmail");
      const password = document.getElementById("loginPassword");

      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();

        try {
          const res = await fetch(API + "/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ email: email.value.trim(), password: password.value.trim() })
          });

          let data = {};
          try { data = await res.json(); } catch {}

          if (!res.ok) {
            alert(data?.error || "Credenciales inválidas");
            return;
          }

          // Obtiene el usuario en sesión
          const me = await fetch(API + "/api/auth/me", { credentials: "include" }).then(r => r.json());
          const user = me?.user ?? null;

          // Si hay ?redirect=... y el rol lo permite, usa eso
          const redirect = getQueryParam("redirect");
          if (redirect) {
            // si es staff y el redirect apunta a client, igual permitimos;
            // si es cliente y el redirect apunta a staff, lo llevamos a su catálogo
            if (user && (user.role === "admin" || user.role === "cajero")) {
              return location.replace(redirect.endsWith("catalog-client.html") ? "catalog-staff.html" : redirect);
            }
            if (user && user.role === "cliente") {
              return location.replace(redirect.endsWith("catalog-staff.html") ? "catalog-client.html" : redirect);
            }
          }

          // Redirección por rol
          location.replace(getRedirectTargetByRole(user));

        } catch (e) {
          console.error(e);
          alert("No se pudo conectar con la API en " + API);
        }
      });
    });
  })();
  </script>
</body>
</html>
