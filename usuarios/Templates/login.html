<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión — Al Sahara</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Tu CSS (ajusta la ruta si corresponde) -->
  <link rel="stylesheet" href="./core/styles.css">
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-utensils"></i> Al Sahara</a>
    </div>
  </nav>

  <main class="container py-5" style="max-width: 680px;">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h1 class="h3 text-center mb-4">Iniciar Sesión</h1>

        <div class="alert alert-info">
          <strong>Usuarios de prueba:</strong><br>
          Cliente: correo@example.com / Elpepe2025<br>
          Admin: admin@alsahara.cl / Admin2025<br>
          Cajero: cajero@alsahara.cl / Elpepe2025
        </div>

        <div id="alert-placeholder"></div>

        <form id="loginForm" class="vstack gap-3">
          <div>
            <label class="form-label" for="loginEmail">Email</label>
            <input id="loginEmail" type="email" class="form-control" required />
          </div>
          <div>
            <label class="form-label" for="loginPassword">Contraseña</label>
            <input id="loginPassword" type="password" class="form-control" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="fa fa-right-to-bracket"></i> Iniciar sesión
          </button>
        </form>
      </div>
      </div>
        <div class="text-center mt-3">
            <div><a href="recover.html">¿Olvidaste tu contraseña?</a></div>
        <div class="mt-1"><a href="register.html">¿No tienes cuenta? Regístrate</a></div>
      </div>

  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // 1. Obtenemos el formulario y el lugar para las alertas
      const loginForm = document.getElementById('loginForm');
      const alertPlaceholder = document.getElementById('alert-placeholder');

      // 2. Esta función mostrará las alertas de Bootstrap
      const showAlert = (message, type = 'danger') => {
        alertPlaceholder.innerHTML = `
          <div class="alert alert-${type} alert-dismissible" role="alert">
            <div>${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
      };

      // 3. Esta es la función principal que se ejecuta al enviar el form
      const handleLogin = async (event) => {
        // 3.1. Evitamos que la página se recargue
        event.preventDefault();

        // 3.2. Obtenemos los valores del formulario
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        // 3.3. Creamos el "cuerpo" (body) que enviaremos a la API
        const requestBody = {
          email: email,
          password: password
        };

        try {
          // 3.4. Hacemos la petición POST a la API
          const response = await fetch('http://127.0.0.1:8000/api/auth/login/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody),
            
            // ESTA LÍNEA ES LA MÁS IMPORTANTE
            // Le dice al navegador que envíe y reciba las cookies de sesión.
            credentials: 'include' 
          });

          if (response.ok) {
            // Si el login es exitoso (status 200)
            const userData = await response.json();
            console.log('Login exitoso:', userData);

            // --- ¡NUEVA LÓGICA DE REDIRECCIÓN POR ROL! ---
            // (Asumo que tu UserSerializer devuelve "role": "cliente" o "role": "staff")

            if (userData.role === 'staff' || userData.role === 'admin') {
                // Si es staff o admin, va al panel de staff
                showAlert('¡Inicio de sesión exitoso (Staff)! Redirigiendo...', 'success');
                setTimeout(() => {
                    window.location.href = 'catalog-staff.html';
                }, 1000);

            } else {
                // Si es cliente, va al catálogo de cliente
                showAlert('¡Inicio de sesión exitoso! Redirigiendo...', 'success');
                setTimeout(() => {
                    window.location.href = 'catalog-client.html';
                }, 1000);
            }
            // --- FIN DE LA LÓGICA DE REDIRECCIÓN ---

          } else {
            // Si el login falla (status 400, 401, etc.)
            const errorData = await response.json();
            const errorMessage = errorData.error || 'Error desconocido';
            showAlert(errorMessage, 'danger');
            
            // --- ERROR CRÍTICO ARREGLADO ---
            // Había un bloque 'if/else' duplicado aquí. Lo he eliminado.
          }

        } catch (error) {
          // Si hay un error de red (ej: la API está caída)
          console.error('Error de red:', error);
          showAlert('No se pudo conectar con el servidor. Intenta más tarde.', 'warning');
        }
      };

      // 4. Conectamos la función handleLogin al evento "submit" del formulario
      loginForm.addEventListener('submit', handleLogin);
    </script>
</body>
</html>